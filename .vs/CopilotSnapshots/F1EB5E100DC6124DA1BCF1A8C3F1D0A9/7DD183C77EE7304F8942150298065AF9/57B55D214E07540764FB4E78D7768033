using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Windows.Forms;

namespace QuanLiNhaThuoc
{
    public partial class Form1 : DevExpress.XtraEditors.XtraForm
    {
 

        public Form1()
        {
            InitializeComponent();
            this.Load += Form1_Load;
            this.Load += FormDashboard_Load;
        }

        private void Form1_Load(object sender, EventArgs e)
        {
            timerClock.Tick += timerClock_Tick;
            timerClock.Interval = 1000; // 1 giây
            timerClock.Start();
        }

        private void timerClock_Tick(object sender, EventArgs e)
        {
            lblTime.Text = DateTime.Now.ToString("HH:mm:ss");
            lblDate.Text = DateTime.Now.ToString("dd/MM/yyyy");
        }

        private void FormDashboard_Load(object sender, EventArgs e)
        {
            using (var db = new DatabaseHelper())
            {
                // 1. Doanh thu hôm nay
                string queryDoanhThu = $@"SELECT ISNULL(SUM(TongTien), 0) AS DoanhThu FROM HoaDon     WHERE CAST(NgayBan AS DATE) = '2024-06-01'";
                var dtDoanhThu = db.ExecuteQuery(queryDoanhThu);
                lblDoanhThuHomNay.Text = string.Format("{0:N0} đ", dtDoanhThu.Rows[0][0]);

                // 2. Số lượng thuốc sắp hết (ví dụ: SoLuongTon <= 10)
                string querySapHet = "SELECT COUNT(*) AS SoLuongThuocSapHet FROM Thuoc WHERE SoLuongTon <= 50";
                var dtSapHet = db.ExecuteQuery(querySapHet);
                lblThuocSapHet.Text = dtSapHet.Rows[0][0].ToString();

                // 3. Số loại thuốc sắp hết hạn (trong 30 ngày tới)
                string querySapHetHan = @"SELECT COUNT(DISTINCT MaThuoc) FROM ChiTietPhieuNhap WHERE HanSuDung <= DATEADD(day, 30, GETDATE()) AND HanSuDung >= GETDATE()";
                var dtSapHetHan = db.ExecuteQuery(querySapHetHan);
                lblThuocSapHetHan.Text = dtSapHetHan.Rows[0][0].ToString();

                // 4. Hóa đơn gần nhất
                string queryHD = @"SELECT TOP 1 h.MaHoaDon, k.HoTenKH, h.NgayBan FROM HoaDon h JOIN KhachHang k ON h.MaKhachHang = k.MaKhachHang ORDER BY h.NgayBan DESC, h.MaHoaDon DESC";
                var dtHD = db.ExecuteQuery(queryHD);
                if (dtHD.Rows.Count > 0)
                {
                    var row = dtHD.Rows[0];
                    lblHoaDon.Text = $"HD: {row[0]} - {row[1]} - {Convert.ToDateTime(row[2]):dd/MM/yyyy}";
                }
                else
                {
                    lblHoaDon.Text = "Không có hóa đơn";
                }
            }
        }

        private void CapNhatDuLieuChartBanNhapTuanThang6()
        {
            DateTime fromDate = new DateTime(2024, 6, 3);
            DateTime toDate = new DateTime(2024, 6, 9);
            string query = @"
                SELECT Ngay, SUM(Ban) AS Ban, SUM(Nhap) AS Nhap FROM (
                    SELECT CONVERT(date, h.NgayBan) AS Ngay, SUM(cthd.SoLuong) AS Ban, 0 AS Nhap
                    FROM HoaDon h
                    JOIN ChiTietHoaDon cthd ON h.MaHoaDon = cthd.MaHoaDon
                    WHERE h.NgayBan >= @fromDate AND h.NgayBan <= @toDate
                    GROUP BY CONVERT(date, h.NgayBan)
                    UNION ALL
                    SELECT CONVERT(date, pn.NgayNhap) AS Ngay, 0 AS Ban, SUM(ctpn.SoLuongNhap) AS Nhap
                    FROM PhieuNhap pn
                    JOIN ChiTietPhieuNhap ctpn ON pn.MaPhieuNhap = ctpn.MaPhieuNhap
                    WHERE pn.NgayNhap >= @fromDate AND pn.NgayNhap <= @toDate
                    GROUP BY CONVERT(date, pn.NgayNhap)
                ) AS t
                GROUP BY Ngay
                ORDER BY Ngay
            ";
            DataTable dt = new DataTable();
            using (var db = new DatabaseHelper())
            {
                using (var cmd = db.GetCommand(query))
                {
                    cmd.Parameters.Add("@fromDate", System.Data.SqlDbType.Date).Value = fromDate;
                    cmd.Parameters.Add("@toDate", System.Data.SqlDbType.Date).Value = toDate;
                    db.OpenConnection();
                    using (var adapter = new System.Data.SqlClient.SqlDataAdapter(cmd))
                    {
                        adapter.Fill(dt);
                    }
                    db.CloseConnection();
                }
            }
            // Gán dữ liệu vào 2 series đã có sẵn trên chartBan_Nhap
            if (chartBan_Nhap.Series.Count >= 2)
            {
                var seriesBan = chartBan_Nhap.Series[0]; // "Bán"
                var seriesNhap = chartBan_Nhap.Series[1]; // "Nhập"
                seriesBan.Points.Clear();
                seriesNhap.Points.Clear();
                foreach (DataRow row in dt.Rows)
                {
                    string ngay = Convert.ToDateTime(row["Ngay"]).ToString("dd/MM/yyyy");
                    int ban = row["Ban"] != DBNull.Value ? Convert.ToInt32(row["Ban"]) : 0;
                    int nhap = row["Nhap"] != DBNull.Value ? Convert.ToInt32(row["Nhap"]) : 0;
                    seriesBan.Points.AddXY(ngay, ban);
                    seriesNhap.Points.AddXY(ngay, nhap);
                }
            }
        }
    }
}
